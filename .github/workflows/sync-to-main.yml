name: åŒæ­¥devåˆ†æ”¯åˆ°mainåˆ†æ”¯

# æ‰‹åŠ¨è§¦å‘æœºåˆ¶
on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'è‡ªå®šä¹‰æäº¤æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'åŒæ­¥devåˆ†æ”¯çš„æ›´æ”¹åˆ°mainåˆ†æ”¯'
        type: string

# æƒé™é…ç½®
permissions:
  contents: write
  actions: read

jobs:
  sync-branches:
    name: åŒæ­¥åˆ†æ”¯
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitç”¨æˆ·
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: æ‰§è¡Œåˆ†æ”¯åŒæ­¥
        run: |
          echo "ðŸš€ å¼€å§‹åŒæ­¥devåˆ†æ”¯åˆ°mainåˆ†æ”¯"
          echo "å·¥ä½œæµè§¦å‘åˆ†æ”¯: ${{ github.ref_name }}"

          # ç¡®ä¿åœ¨mainåˆ†æ”¯
          git checkout main
          echo "âœ… å½“å‰åœ¨mainåˆ†æ”¯: $(git branch --show-current)"

          # åˆ›å»ºå¤‡ä»½æ ‡ç­¾
          BACKUP_TAG="backup-main-$(date +%Y%m%d-%H%M%S)"
          git tag $BACKUP_TAG
          echo "âœ… åˆ›å»ºå¤‡ä»½æ ‡ç­¾: $BACKUP_TAG"

          # ä»Ždevåˆ†æ”¯åˆå¹¶ï¼Œä½†æŽ’é™¤ç‰¹å®šæ–‡ä»¶å¤¹
          echo ""
          echo "ðŸ“‚ å¼€å§‹ä»Ždevåˆ†æ”¯åŒæ­¥æ–‡ä»¶..."

          # åˆ‡æ¢åˆ°devåˆ†æ”¯æŸ¥çœ‹å†…å®¹
          git checkout dev
          echo "devåˆ†æ”¯å†…å®¹:"
          ls -la

          # ä½¿ç”¨git checkouté€‰æ‹©æ€§åˆå¹¶æ–‡ä»¶
          git checkout main

          # é€ä¸ªåŒæ­¥æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼ˆæŽ’é™¤assetså’Œdevæ–‡ä»¶å¤¹ï¼‰
          git checkout dev -- . 2>/dev/null || true

          # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶å¤¹
          if [ -d "assets" ]; then
            rm -rf assets
            echo "âŒ å·²æŽ’é™¤: assets/ æ–‡ä»¶å¤¹"
          fi

          if [ -d "dev" ]; then
            rm -rf dev
            echo "âŒ å·²æŽ’é™¤: dev/ æ–‡ä»¶å¤¹"
          fi

          # æ¢å¤mainåˆ†æ”¯çš„.gitignore
          git checkout HEAD -- .gitignore 2>/dev/null || true
          echo "âœ… ä¿ç•™mainåˆ†æ”¯çš„.gitignoreé…ç½®"

          echo ""
          echo "ðŸ“‹ åŒæ­¥åŽçš„mainåˆ†æ”¯å†…å®¹:"
          ls -la
      
      - name: æ£€æŸ¥æ›´æ”¹å¹¶æäº¤
        run: |
          echo ""
          echo "ðŸ” æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤..."

          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦åŒæ­¥çš„æ›´æ”¹"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "âœ… æ£€æµ‹åˆ°éœ€è¦åŒæ­¥çš„æ›´æ”¹:"
            git status --porcelain
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: æäº¤å¹¶æŽ¨é€æ›´æ”¹
        if: env.HAS_CHANGES == 'true'
        run: |
          echo "ðŸ“ æäº¤æ›´æ”¹åˆ°mainåˆ†æ”¯..."

          # ä½¿ç”¨è‡ªå®šä¹‰æäº¤æ¶ˆæ¯æˆ–é»˜è®¤æ¶ˆæ¯
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="åŒæ­¥devåˆ†æ”¯çš„æ›´æ”¹åˆ°mainåˆ†æ”¯"
          fi

          # åˆ›å»ºè¯¦ç»†çš„æäº¤æ¶ˆæ¯
          FULL_MSG="$COMMIT_MSG

          ðŸ”„ åŒæ­¥ä¿¡æ¯:
          - æºåˆ†æ”¯: dev â†’ main
          - åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - è§¦å‘è€…: ${{ github.actor }}
          - æŽ’é™¤æ–‡ä»¶å¤¹: assets/, dev/
          - å·¥ä½œæµ: ${{ github.run_id }}"

          # æäº¤æ›´æ”¹
          git commit -m "$FULL_MSG"
          echo "âœ… å·²æäº¤æ›´æ”¹åˆ°mainåˆ†æ”¯"

          # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
          echo "ðŸ“¤ æŽ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
          git push origin main
          echo "âœ… å·²æŽ¨é€mainåˆ†æ”¯æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“"

      - name: è¾“å‡ºåŒæ­¥ç»“æžœ
        if: always()
        run: |
          echo ""
          echo "ðŸŽ‰ åŒæ­¥æ“ä½œå®Œæˆï¼"
          echo "================================"

          if [ "$HAS_CHANGES" == "true" ]; then
            echo "âœ… åŒæ­¥æˆåŠŸï¼devåˆ†æ”¯çš„æ›´æ”¹å·²åŒæ­¥åˆ°mainåˆ†æ”¯"
            echo "ðŸ“ æäº¤æ¶ˆæ¯: ${{ github.event.inputs.commit_message }}"
            echo "ðŸ”— æŸ¥çœ‹mainåˆ†æ”¯: https://github.com/${{ github.repository }}/tree/main"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹ï¼Œä¸¤ä¸ªåˆ†æ”¯å·²ä¿æŒåŒæ­¥"
          fi

          echo ""
          echo "ðŸ“Š åˆ†æ”¯çŠ¶æ€æ€»ç»“:"
          git checkout main 2>/dev/null || true
          echo "mainåˆ†æ”¯æœ€æ–°æäº¤: $(git log -1 --oneline)"
          echo "mainåˆ†æ”¯æ–‡ä»¶åˆ—è¡¨:"
          ls -la

          echo ""
          echo "ðŸŽ¯ åŒæ­¥ç­–ç•¥:"
          echo "- âœ… å·²åŒæ­¥: é™¤assets/å’Œdev/æ–‡ä»¶å¤¹å¤–çš„æ‰€æœ‰å†…å®¹"
          echo "- âŒ å·²æŽ’é™¤: assets/ æ–‡ä»¶å¤¹ï¼ˆè®¾è®¡èµ„æºï¼‰"
          echo "- âŒ å·²æŽ’é™¤: dev/ æ–‡ä»¶å¤¹ï¼ˆå¼€å‘æ–‡ä»¶ï¼‰"
          echo "- âœ… å·²ä¿ç•™: mainåˆ†æ”¯çš„.gitignoreé…ç½®"

      - name: é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo ""
          echo "âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
          echo "================================"
          echo "è¯·æ£€æŸ¥ä¸Šæ–¹çš„å·¥ä½œæµæ—¥å¿—ä»¥èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo ""
          echo "ðŸ’¡ å¸¸è§è§£å†³æ–¹æ¡ˆ:"
          echo "1. æ£€æŸ¥devåˆ†æ”¯æ˜¯å¦æœ‰æœ€æ–°çš„æ›´æ”¹"
          echo "2. ç¡®è®¤æ²¡æœ‰æ–‡ä»¶æƒé™é—®é¢˜"
          echo "3. é‡æ–°è¿è¡Œå·¥ä½œæµ"
          echo "4. å¦‚æœ‰æŒç»­é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»“åº“è®¾ç½®"

          # ç¡®ä¿å›žåˆ°å®‰å…¨çŠ¶æ€
          git checkout main 2>/dev/null || true
