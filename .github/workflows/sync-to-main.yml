name: åŒæ­¥devåˆ†æ”¯åˆ°mainåˆ†æ”¯

# æ‰‹åŠ¨è§¦å‘æœºåˆ¶
on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'è‡ªå®šä¹‰æäº¤æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'åŒæ­¥devåˆ†æ”¯çš„æ›´æ”¹åˆ°mainåˆ†æ”¯'
        type: string
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥å†²çªè­¦å‘Šï¼‰'
        required: false
        default: false
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  sync-branches:
    name: åŒæ­¥åˆ†æ”¯
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitç”¨æˆ·
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: æ£€æŸ¥åˆ†æ”¯çŠ¶æ€å¹¶åˆ‡æ¢åˆ°devåˆ†æ”¯
        run: |
          echo "å·¥ä½œæµè§¦å‘åˆ†æ”¯: ${{ github.ref_name }}"
          echo "åˆ‡æ¢åˆ°devåˆ†æ”¯èŽ·å–æœ€æ–°å†…å®¹..."
          git checkout dev
          echo "devåˆ†æ”¯æœ€æ–°æäº¤: $(git rev-parse HEAD)"
          git checkout main
          echo "mainåˆ†æ”¯æœ€æ–°æäº¤: $(git rev-parse HEAD)"
      
      - name: ä»Ždevåˆ†æ”¯å‡†å¤‡åŒæ­¥æ–‡ä»¶
        run: |
          echo "ä»Ždevåˆ†æ”¯å‡†å¤‡åŒæ­¥çš„æ–‡ä»¶..."

          # åˆ‡æ¢åˆ°devåˆ†æ”¯èŽ·å–æœ€æ–°æ–‡ä»¶
          git checkout dev

          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨è¦åŒæ­¥çš„æ–‡ä»¶
          mkdir -p /tmp/sync-files

          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶ï¼ˆæŽ’é™¤assets/å’Œdev/æ–‡ä»¶å¤¹ï¼‰
          # å¤åˆ¶.jsxè„šæœ¬æ–‡ä»¶ï¼ˆå¦‚æžœåœ¨æ ¹ç›®å½•ï¼‰
          find . -maxdepth 1 -name "*.jsx" -type f | while read file; do
            if [ -f "$file" ]; then
              cp "$file" "/tmp/sync-files/"
              echo "å·²å‡†å¤‡åŒæ­¥: $file"
            fi
          done

          # å¤åˆ¶readme.md
          if [ -f "readme.md" ]; then
            cp "readme.md" "/tmp/sync-files/"
            echo "å·²å‡†å¤‡åŒæ­¥: readme.md"
          fi

          # å¤åˆ¶å…¶ä»–é‡è¦é…ç½®æ–‡ä»¶ï¼ˆä»Ždevåˆ†æ”¯ï¼‰
          for pattern in "*.json" "*.txt" "*.yml" "*.yaml"; do
            find . -maxdepth 1 -name "$pattern" -type f | while read f; do
              if [ -f "$f" ] && [[ "$f" != "./readme.md" ]] && [[ "$f" != "./.github"* ]]; then
                cp "$f" "/tmp/sync-files/"
                echo "å·²å‡†å¤‡åŒæ­¥: $f"
              fi
            done
          done

          echo "åŒæ­¥æ–‡ä»¶å‡†å¤‡å®Œæˆ"
          ls -la /tmp/sync-files/ || echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦åŒæ­¥"
      
      - name: åˆ‡æ¢åˆ°mainåˆ†æ”¯å¹¶åº”ç”¨æ›´æ”¹
        run: |
          # åˆ‡æ¢åˆ°mainåˆ†æ”¯
          git checkout main

          # å¤‡ä»½å½“å‰mainåˆ†æ”¯çŠ¶æ€
          git tag backup-main-$(date +%Y%m%d-%H%M%S)

          # ä¿ç•™mainåˆ†æ”¯çš„.gitignoreæ–‡ä»¶
          cp .gitignore /tmp/main-gitignore 2>/dev/null || echo "mainåˆ†æ”¯æ²¡æœ‰.gitignoreæ–‡ä»¶"

          # å¤åˆ¶å‡†å¤‡å¥½çš„æ–‡ä»¶åˆ°mainåˆ†æ”¯
          if [ -d "/tmp/sync-files" ] && [ "$(ls -A /tmp/sync-files 2>/dev/null)" ]; then
            cp /tmp/sync-files/* . 2>/dev/null || true
            echo "å·²å¤åˆ¶åŒæ­¥æ–‡ä»¶åˆ°mainåˆ†æ”¯"
          else
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦åŒæ­¥"
          fi

          # æ¢å¤mainåˆ†æ”¯çš„.gitignoreæ–‡ä»¶
          if [ -f "/tmp/main-gitignore" ]; then
            cp /tmp/main-gitignore .gitignore
            echo "å·²æ¢å¤mainåˆ†æ”¯çš„.gitignoreæ–‡ä»¶"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          git add . 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦åŒæ­¥çš„æ›´æ”¹"
            echo "SYNC_NEEDED=false" >> $GITHUB_ENV
          else
            echo "æ£€æµ‹åˆ°éœ€è¦åŒæ­¥çš„æ›´æ”¹"
            echo "SYNC_NEEDED=true" >> $GITHUB_ENV
            git status --porcelain
          fi
      
      - name: æäº¤æ›´æ”¹åˆ°mainåˆ†æ”¯
        if: env.SYNC_NEEDED == 'true'
        run: |
          # ä½¿ç”¨è‡ªå®šä¹‰æäº¤æ¶ˆæ¯æˆ–é»˜è®¤æ¶ˆæ¯
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="åŒæ­¥devåˆ†æ”¯çš„æ›´æ”¹åˆ°mainåˆ†æ”¯"
          fi
          
          # æ·»åŠ åŒæ­¥ä¿¡æ¯åˆ°æäº¤æ¶ˆæ¯
          FULL_MSG="$COMMIT_MSG

          åŒæ­¥ä¿¡æ¯:
          - æºåˆ†æ”¯: dev
          - åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - è§¦å‘è€…: ${{ github.actor }}
          - å·¥ä½œæµè¿è¡Œ: ${{ github.run_id }}"
          
          git commit -m "$FULL_MSG"
          echo "å·²æäº¤æ›´æ”¹åˆ°mainåˆ†æ”¯"
      
      - name: æŽ¨é€mainåˆ†æ”¯æ›´æ”¹
        if: env.SYNC_NEEDED == 'true'
        run: |
          git push origin main
          echo "å·²æŽ¨é€mainåˆ†æ”¯æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“"
      
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/sync-files /tmp/main-gitignore 2>/dev/null || true
          echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
      
      - name: è¾“å‡ºåŒæ­¥ç»“æžœ
        run: |
          if [ "$SYNC_NEEDED" == "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆï¼devåˆ†æ”¯çš„æ›´æ”¹å·²æˆåŠŸåŒæ­¥åˆ°mainåˆ†æ”¯"
            echo "ðŸ“ æäº¤æ¶ˆæ¯: ${{ github.event.inputs.commit_message }}"
            echo "ðŸ”— æŸ¥çœ‹mainåˆ†æ”¯: https://github.com/${{ github.repository }}/tree/main"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹"
          fi
          
          echo "ðŸŒ¿ å½“å‰åˆ†æ”¯çŠ¶æ€:"
          git checkout main
          echo "mainåˆ†æ”¯æœ€æ–°æäº¤: $(git log -1 --oneline)"
          git checkout dev
          echo "devåˆ†æ”¯æœ€æ–°æäº¤: $(git log -1 --oneline)"
      
      - name: é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
          echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥èŽ·å–è¯¦ç»†ä¿¡æ¯"
          echo "å¦‚æžœé‡åˆ°åˆå¹¶å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³åŽé‡æ–°è¿è¡Œå·¥ä½œæµ"
          
          # å°è¯•æ¢å¤åˆ°å®‰å…¨çŠ¶æ€
          git checkout dev 2>/dev/null || true
          
          # æ¸…ç†å¯èƒ½çš„ä¸´æ—¶åˆ†æ”¯
          if [ ! -z "$TEMP_BRANCH" ]; then
            git branch -D $TEMP_BRANCH 2>/dev/null || true
          fi
