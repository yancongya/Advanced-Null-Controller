name: é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™

# ä»…åœ¨æ¨é€åˆ°devåˆ†æ”¯æ—¶è§¦å‘ï¼ˆç”¨äºåˆå§‹åŒ–è®¾ç½®ï¼‰
on:
  workflow_dispatch:
    inputs:
      setup_protection:
        description: 'è®¾ç½®devåˆ†æ”¯ä¿æŠ¤è§„åˆ™'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  administration: write

jobs:
  setup-protection:
    name: è®¾ç½®åˆ†æ”¯ä¿æŠ¤
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: é…ç½®devåˆ†æ”¯ä¿æŠ¤è§„åˆ™
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              // è®¾ç½®devåˆ†æ”¯ä¿æŠ¤è§„åˆ™
              await github.rest.repos.updateBranchProtection({
                owner: owner,
                repo: repo,
                branch: 'dev',
                required_status_checks: null,
                enforce_admins: false,
                required_pull_request_reviews: {
                  required_approving_review_count: 0,
                  dismiss_stale_reviews: false,
                  require_code_owner_reviews: false
                },
                restrictions: {
                  users: [owner], // åªå…è®¸ä»“åº“æ‰€æœ‰è€…è®¿é—®
                  teams: []
                },
                allow_force_pushes: false,
                allow_deletions: false
              });
              
              console.log('âœ… devåˆ†æ”¯ä¿æŠ¤è§„åˆ™è®¾ç½®æˆåŠŸ');
              
              // è®¾ç½®åˆ†æ”¯å¯è§æ€§ï¼ˆé€šè¿‡æ›´æ–°ä»“åº“è®¾ç½®ï¼‰
              await github.rest.repos.update({
                owner: owner,
                repo: repo,
                default_branch: 'main', // ç¡®ä¿mainæ˜¯é»˜è®¤åˆ†æ”¯
                has_wiki: false,
                has_projects: true,
                has_issues: true
              });
              
              console.log('âœ… ä»“åº“è®¾ç½®æ›´æ–°æˆåŠŸ');
              
            } catch (error) {
              console.error('âŒ è®¾ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error.message);
              
              // å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
              if (error.status === 403) {
                console.log('ğŸ’¡ è§£å†³æ–¹æ¡ˆ:');
                console.log('1. ç¡®ä¿GitHub Tokenå…·æœ‰adminæƒé™');
                console.log('2. æˆ–è€…æ‰‹åŠ¨åœ¨ä»“åº“è®¾ç½®ä¸­é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™');
              }
            }

      - name: è¾“å‡ºé…ç½®ä¿¡æ¯
        run: |
          echo "ğŸ”’ åˆ†æ”¯ä¿æŠ¤é…ç½®å®Œæˆ"
          echo ""
          echo "ğŸ“‹ é…ç½®è¯¦æƒ…:"
          echo "- devåˆ†æ”¯: å—ä¿æŠ¤åˆ†æ”¯ï¼Œé™åˆ¶è®¿é—®"
          echo "- mainåˆ†æ”¯: å…¬å¼€åˆ†æ”¯ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒ"
          echo ""
          echo "ğŸ”§ æ‰‹åŠ¨é…ç½®æ­¥éª¤ï¼ˆå¦‚æœè‡ªåŠ¨é…ç½®å¤±è´¥ï¼‰:"
          echo "1. è¿›å…¥ä»“åº“è®¾ç½® â†’ Branches"
          echo "2. ä¸ºdevåˆ†æ”¯æ·»åŠ ä¿æŠ¤è§„åˆ™"
          echo "3. å¯ç”¨ 'Restrict pushes that create files'"
          echo "4. åœ¨ 'Restrict pushes that create files' ä¸­æ·»åŠ ä»“åº“æ‰€æœ‰è€…"
